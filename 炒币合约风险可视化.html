<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专业数字货币交易风控系统 V2.4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #2962ff;
            --secondary: #0039cb;
            --dark-bg: #121826;
            --dark-card: #1d2433;
            --success: #00c853;
            --danger: #ff3d00;
            --warning: #ffab00;
            --info: #00b0ff;
            --text: #e0e0e0;
            --text-secondary: #a0a0a0;
            --long: #00c853;
            --short: #ff3d00;
            --border: #2a3441;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #0d1117 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: var(--dark-card);
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .account-info {
            background: linear-gradient(135deg, var(--dark-card), var(--dark-bg));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .account-stat {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .account-stat .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .account-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text);
        }

        .account-stat.primary .value {
            color: var(--primary);
        }

        .account-stat.success .value {
            color: var(--success);
        }

        .account-stat.warning .value {
            color: var(--warning);
        }

        .account-stat.danger .value {
            color: var(--danger);
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--dark-card);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 {
            color: var(--info);
            margin: 20px 0 15px;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--dark-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.1);
        }

        .input-with-percent {
            position: relative;
        }

        .input-with-percent input {
            padding-right: 100px;
        }

        .percent-buttons {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px;
        }

        .percent-btn {
            padding: 5px 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .percent-btn:hover {
            background: var(--secondary);
        }

        .direction-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .direction-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            font-weight: 600;
        }

        .long-btn {
            background: rgba(0, 200, 83, 0.1);
            color: var(--long);
        }

        .long-btn.active {
            background: var(--long);
            color: white;
            border-color: var(--long);
        }

        .short-btn {
            background: rgba(255, 61, 0, 0.1);
            color: var(--short);
        }

        .short-btn.active {
            background: var(--short);
            color: white;
            border-color: var(--short);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(41, 98, 255, 0.3);
        }

        .btn-calculate {
            background: linear-gradient(135deg, var(--primary), var(--info));
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 10px;
        }

        .btn-reset {
            background: var(--danger);
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-group button {
            flex: 1;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
        }

        .orders-table table {
            width: 100%;
        }

        .orders-table th {
            background: var(--dark-bg);
            padding: 12px;
            text-align: left;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        .orders-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            white-space: nowrap;
        }

        .orders-table tr:hover {
            background: rgba(41, 98, 255, 0.05);
        }

        .liquidation-prices {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .liq-price {
            font-size: 0.85rem;
        }

        .liq-isolated {
            color: var(--warning);
        }

        .liq-cross {
            color: var(--danger);
        }

        .tag {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .tag-long {
            background: rgba(0, 200, 83, 0.2);
            color: var(--long);
        }

        .tag-short {
            background: rgba(255, 61, 0, 0.2);
            color: var(--short);
        }

        .btn-delete {
            background: var(--danger);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .btn-edit {
            background: var(--info);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
        }

        .risk-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .indicator {
            background: var(--dark-bg);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .indicator .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .indicator .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text);
        }

        .indicator .description {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .indicator.danger .value {
            color: var(--danger);
        }

        .indicator.warning .value {
            color: var(--warning);
        }

        .indicator.success .value {
            color: var(--success);
        }

        .chart-container {
            margin-top: 30px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .recommendations {
            background: var(--dark-bg);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border);
        }

        .recommendation-list {
            list-style: none;
            padding: 0;
        }

        .recommendation-list li {
            padding: 12px;
            margin-bottom: 10px;
            background: var(--dark-card);
            border-left: 4px solid var(--warning);
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recommendation-list li.success {
            border-left-color: var(--success);
        }

        .recommendation-list li.danger {
            border-left-color: var(--danger);
        }

        .recommendation-list li.info {
            border-left-color: var(--info);
        }

        .note {
            background: var(--dark-card);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border);
            margin-top: 30px;
        }

        .note h4 {
            color: var(--warning);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .note ul {
            list-style: none;
            padding-left: 0;
        }

        .note li {
            padding: 8px 0;
            color: var(--text-secondary);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .note li:before {
            content: "•";
            color: var(--primary);
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--dark-card);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--border);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--primary);
            margin: 0;
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: var(--danger);
        }

        .alert-box {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            z-index: 2000;
        }

        .alert {
            background: var(--dark-card);
            border-left: 4px solid;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .alert.success {
            border-left-color: var(--success);
        }

        .alert.danger {
            border-left-color: var(--danger);
        }

        .alert.warning {
            border-left-color: var(--warning);
        }

        .alert.info {
            border-left-color: var(--info);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .advanced-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: var(--dark-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .metric-card .metric-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .metric-card .metric-value {
            color: var(--text);
            font-size: 1.3rem;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--dark-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
            transition: width 0.3s ease;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: var(--dark-bg);
            color: var(--text);
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid var(--border);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-buttons button {
            flex: 1;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-coins"></i> 专业数字货币交易风控系统 V2.4</h1>
            <p class="subtitle">精准计算强平价格 · 全方位风险评估 · 智能仓位管理建议</p>
        </header>

        <div class="alert-box" id="alertBox"></div>

        <!-- 账户信息展示 -->
        <div class="account-info" id="accountInfo">
            <div class="account-stat primary">
                <div class="label">账户总资金</div>
                <div class="value" id="displayCapital">$10,000</div>
            </div>
            <div class="account-stat success">
                <div class="label">可用余额</div>
                <div class="value" id="availableBalance">$10,000</div>
            </div>
            <div class="account-stat warning">
                <div class="label">已用保证金</div>
                <div class="value" id="usedMargin">$0</div>
            </div>
            <div class="account-stat">
                <div class="label">未实现盈亏</div>
                <div class="value" id="unrealizedPnL">$0</div>
            </div>
            <div class="account-stat danger">
                <div class="label">风险度</div>
                <div class="value" id="riskLevel">0%</div>
            </div>
        </div>

        <div class="grid-container">
            <!-- 输入区域 -->
            <div class="card">
                <h2><i class="fas fa-sliders-h"></i> 交易参数设置</h2>

                <div class="form-group">
                    <label for="capital">账户总资金 (USDT)</label>
                    <input type="number" id="capital" value="10000" min="0" step="100" onchange="updateAccountInfo()">
                </div>

                <div class="form-group">
                    <label for="riskTolerance">
                        风险偏好
                        <span class="tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltiptext">
                                保守型：单笔风险1%，总仓位不超过20%<br>
                                稳健型：单笔风险2%，总仓位不超过30%<br>
                                激进型：单笔风险3%，总仓位不超过50%
                            </span>
                        </span>
                    </label>
                    <select id="riskTolerance">
                        <option value="conservative">保守型</option>
                        <option value="moderate" selected>稳健型</option>
                        <option value="aggressive">激进型</option>
                    </select>
                </div>

                <h3><i class="fas fa-plus-circle"></i> 添加新订单</h3>

                <div class="direction-toggle">
                    <div class="direction-btn long-btn active" id="longBtn">
                        <i class="fas fa-arrow-up"></i> 做多 Long
                    </div>
                    <div class="direction-btn short-btn" id="shortBtn">
                        <i class="fas fa-arrow-down"></i> 做空 Short
                    </div>
                </div>

                <div class="form-group">
                    <label for="coin">交易对</label>
                    <input type="text" id="coin" placeholder="例如: BTC/USDT" value="BTC/USDT">
                </div>

                <div class="form-group">
                    <label for="leverage">
                        杠杆倍数
                        <span class="tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltiptext">
                                杠杆越高，强平价格越接近开仓价格。<br>
                                建议新手使用5倍以下杠杆。
                            </span>
                        </span>
                    </label>
                    <input type="number" id="leverage" value="10" min="1" max="125" step="1">
                </div>

                <div class="form-group">
                    <label for="entry">开仓价格 (USDT)</label>
                    <input type="number" id="entry" placeholder="输入计划开仓价格" step="0.01">
                </div>

                <div class="form-group">
                    <label for="stopLoss">止损价格 (USDT)</label>
                    <input type="number" id="stopLoss" placeholder="输入止损价格" step="0.01">
                </div>

                <div class="form-group">
                    <label for="takeProfit">止盈价格 (USDT)</label>
                    <input type="number" id="takeProfit" placeholder="输入止盈价格" step="0.01">
                </div>

                <div class="form-group">
                    <label for="margin">投入保证金 (USDT)</label>
                    <div class="input-with-percent">
                        <input type="number" id="margin" placeholder="输入保证金金额" step="1">
                        <div class="percent-buttons">
                            <button class="percent-btn" onclick="setMarginByRisk()">风控计算</button>
                            <button class="percent-btn" onclick="setMarginPercent(10)">10%</button>
                            <button class="percent-btn" onclick="setMarginPercent(20)">20%</button>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="addOrderBtn" style="width: 100%;">
                    <i class="fas fa-plus"></i> 添加订单
                </button>

                <!-- 订单列表 -->
                <div class="orders-list" style="margin-top: 30px;">
                    <h3><i class="fas fa-list"></i> 当前订单列表</h3>
                    <div class="orders-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>交易对</th>
                                    <th>方向</th>
                                    <th>杠杆</th>
                                    <th>开仓价</th>
                                    <th>止损价</th>
                                    <th>止盈价</th>
                                    <th>保证金</th>
                                    <th>强平价格</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr><td colspan="9" style="text-align: center; color: #a0a0a0;">暂无订单</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-calculate" id="calculateBtn">
                        <i class="fas fa-calculator"></i> 计算综合风险
                    </button>
                    <button class="btn btn-reset" id="resetBtn">
                        <i class="fas fa-redo"></i> 重置所有
                    </button>
                </div>
            </div>

            <!-- 结果展示区域 -->
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> 风险分析仪表板</h2>

                <!-- 主要风险指标 -->
                <div class="risk-indicators">
                    <div class="indicator" id="totalMarginIndicator">
                        <div class="label">总保证金</div>
                        <div class="value">0 USDT</div>
                        <div class="description">占总资金: 0%</div>
                    </div>
                    <div class="indicator" id="marginRatioIndicator">
                        <div class="label">保证金使用率</div>
                        <div class="value">0%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="marginProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="indicator" id="totalExposureIndicator">
                        <div class="label">总持仓价值</div>
                        <div class="value">0 USDT</div>
                        <div class="description">杠杆后价值</div>
                    </div>
                    <div class="indicator" id="maxLossIndicator">
                        <div class="label">最大潜在损失</div>
                        <div class="value">0 USDT</div>
                        <div class="description">占总资金: 0%</div>
                    </div>
                </div>

                <!-- 高级风险指标 -->
                <h3><i class="fas fa-tachometer-alt"></i> 高级风险指标</h3>
                <div class="advanced-metrics" id="advancedMetrics">
                    <div class="metric-card">
                        <div class="metric-label">风险价值 (VaR 95%)</div>
                        <div class="metric-value" id="varValue">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">最大回撤</div>
                        <div class="metric-value" id="maxDrawdown">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">盈亏比</div>
                        <div class="metric-value" id="profitLossRatio">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">固定比例建议</div>
                        <div class="metric-value" id="fixedFractionSuggestion">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">相关性风险</div>
                        <div class="metric-value" id="correlationRisk">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">风险调整收益</div>
                        <div class="metric-value" id="riskAdjustedReturn">-</div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="chart-container">
                    <h3><i class="fas fa-chart-pie"></i> 资金分布</h3>
                    <div class="chart-wrapper">
                        <canvas id="positionChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3><i class="fas fa-chart-bar"></i> 风险敞口分析</h3>
                    <div class="chart-wrapper">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>

                <!-- 智能建议 -->
                <div class="recommendations">
                    <h3><i class="fas fa-lightbulb"></i> 智能风控建议</h3>
                    <div id="riskRecommendations">
                        <ul class="recommendation-list">
                            <li class="success">系统就绪，请添加订单进行分析</li>
                        </ul>
                    </div>
                </div>

                <!-- 导出功能 -->
                <div class="export-section">
                    <h3><i class="fas fa-download"></i> 数据导出</h3>
                    <div class="export-buttons">
                        <button class="btn btn-primary" onclick="exportToJSON()">
                            <i class="fas fa-file-code"></i> 导出JSON
                        </button>
                        <button class="btn btn-primary" onclick="exportToCSV()">
                            <i class="fas fa-file-csv"></i> 导出CSV
                        </button>
                        <button class="btn btn-primary" onclick="saveToLocal()">
                            <i class="fas fa-save"></i> 保存到本地
                        </button>
                        <button class="btn btn-primary" onclick="loadFromLocal()">
                            <i class="fas fa-upload"></i> 加载本地数据
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 说明文档 -->
        <div class="note">
            <h4><i class="fas fa-book"></i> 使用说明与风险提示</h4>
            <ul>
                <li><strong>强平价格计算：</strong>逐仓模式基于单个仓位保证金，全仓模式考虑账户总资金</li>
                <li><strong>风险价值(VaR)：</strong>在95%置信水平下，您的最大可能损失金额</li>
                                <li><strong>盈亏比：</strong>潜在盈利与潜在亏损的比率，建议保持在1.5以上</li>
                <li><strong>固定比例法：</strong>基于账户风险承受能力的仓位管理方法，每笔交易风险固定为账户的1%-3%</li>
                <li><strong>相关性风险：</strong>评估持仓集中度和方向一致性风险</li>
                <li><strong>建议原则：</strong>总保证金不超过账户资金的30%，单笔损失不超过总资金的2%</li>
                <li><strong>重要提醒：</strong>加密货币交易风险极高，请谨慎操作，切勿过度杠杆</li>
            </ul>
        </div>
    </div>

    <!-- 编辑订单模态框 -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑订单</h3>
                <span class="close" id="closeModalBtn">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editOrderId">
                <div class="form-group">
                    <label for="editCoin">交易对</label>
                    <input type="text" id="editCoin">
                </div>
                <div class="form-group">
                    <label for="editLeverage">杠杆倍数</label>
                    <input type="number" id="editLeverage" min="1" max="125">
                </div>
                <div class="form-group">
                    <label for="editEntry">开仓价格</label>
                    <input type="number" id="editEntry" step="0.01">
                </div>
                <div class="form-group">
                    <label for="editStopLoss">止损价格</label>
                    <input type="number" id="editStopLoss" step="0.01">
                </div>
                <div class="form-group">
                    <label for="editTakeProfit">止盈价格</label>
                    <input type="number" id="editTakeProfit" step="0.01">
                </div>
                <div class="form-group">
                    <label for="editMargin">保证金</label>
                    <input type="number" id="editMargin" step="1">
                </div>
                <button class="btn btn-primary" onclick="saveEditOrder()" style="width: 100%;">
                    <i class="fas fa-save"></i> 保存修改
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let orders = [];
        let isLong = true;
        let positionChart = null;
        let riskChart = null;

        // 交易所费率配置
        const EXCHANGE_CONFIG = {
            takerFee: 0.0006,        // Taker手续费 0.06%
            makerFee: 0.0002,        // Maker手续费 0.02%
            maintenanceMarginRate: 0.005,  // 维持保证金率 0.5%
            fundingRate: 0.0001      // 资金费率（每8小时）
        };

        // 风险偏好配置（修改为固定比例法）
        const RISK_PROFILES = {
            conservative: {
                riskPerTrade: 0.01,    // 每笔交易风险1%
                maxMarginRatio: 0.2,    // 最大保证金使用率20%
                maxLeverage: 5
            },
            moderate: {
                riskPerTrade: 0.02,    // 每笔交易风险2%
                maxMarginRatio: 0.3,    // 最大保证金使用率30%
                maxLeverage: 10
            },
            aggressive: {
                riskPerTrade: 0.03,    // 每笔交易风险3%
                maxMarginRatio: 0.5,    // 最大保证金使用率50%
                maxLeverage: 20
            }
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            initCharts();
            updateAccountInfo();
            loadFromLocal(false);
        });

        // 更新账户信息显示
        function updateAccountInfo() {
            const capital = parseFloat(document.getElementById('capital').value) || 0;
            const totalMargin = orders.reduce((sum, order) => sum + order.margin, 0);
            const availableBalance = capital - totalMargin;
            
            // 计算未实现盈亏（简化版本）
            let unrealizedPnL = 0;
            orders.forEach(order => {
                if (order.currentPrice) {
                    const pnl = calculateCurrentPnL(order);
                    unrealizedPnL += pnl;
                }
            });
            
            // 计算风险度
            const riskLevel = capital > 0 ? ((totalMargin / capital) * 100).toFixed(1) : 0;
            
            // 更新显示
            document.getElementById('displayCapital').textContent = `$${capital.toLocaleString()}`;
            document.getElementById('availableBalance').textContent = `$${availableBalance.toLocaleString()}`;
            document.getElementById('usedMargin').textContent = `$${totalMargin.toLocaleString()}`;
            document.getElementById('unrealizedPnL').textContent = unrealizedPnL >= 0 
                ? `+$${unrealizedPnL.toLocaleString()}` 
                : `-$${Math.abs(unrealizedPnL).toLocaleString()}`;
            
            // 风险度颜色
            const riskLevelElement = document.getElementById('riskLevel');
            riskLevelElement.textContent = `${riskLevel}%`;
            riskLevelElement.parentElement.className = 'account-stat';
            if (riskLevel > 80) {
                riskLevelElement.parentElement.classList.add('danger');
            } else if (riskLevel > 50) {
                riskLevelElement.parentElement.classList.add('warning');
            } else {
                riskLevelElement.parentElement.classList.add('success');
            }
            
            // 未实现盈亏颜色
            const pnlElement = document.getElementById('unrealizedPnL');
            pnlElement.parentElement.className = 'account-stat';
            if (unrealizedPnL > 0) {
                pnlElement.parentElement.classList.add('success');
            } else if (unrealizedPnL < 0) {
                pnlElement.parentElement.classList.add('danger');
            }
        }

        // 基于风险管理设置保证金（固定比例法）
        function setMarginByRisk() {
            const capital = parseFloat(document.getElementById('capital').value) || 0;
            const entry = parseFloat(document.getElementById('entry').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const leverage = parseFloat(document.getElementById('leverage').value);
            const riskProfile = RISK_PROFILES[document.getElementById('riskTolerance').value];
            
            if (!capital || !entry || !stopLoss) {
                showAlert('请先填写资金、开仓价和止损价', 'warning');
                return;
            }
            
            // 计算止损幅度
            const stopLossPercentage = Math.abs(entry - stopLoss) / entry;
            
            // 根据固定比例法计算仓位
            // 仓位 = (账户资金 × 风险比例) / 止损幅度
            const riskAmount = capital * riskProfile.riskPerTrade;
            const positionSize = riskAmount / stopLossPercentage;
            
            // 计算所需保证金
            const margin = positionSize / leverage;
            
            // 设置保证金值
            document.getElementById('margin').value = Math.min(margin, capital * 0.5).toFixed(2);
            
            showAlert(`根据固定比例法(${(riskProfile.riskPerTrade * 100).toFixed(0)}%风险)，建议保证金为$${margin.toFixed(2)}`, 'info');
        }

        // 设置保证金百分比
        function setMarginPercent(percent) {
            const capital = parseFloat(document.getElementById('capital').value) || 0;
            const marginAmount = (capital * percent / 100).toFixed(2);
            document.getElementById('margin').value = marginAmount;
        }

        // 计算当前盈亏
        function calculateCurrentPnL(order) {
            if (!order.currentPrice) return 0;
            
            const priceChange = order.direction === 'Long'
                ? (order.currentPrice - order.entry) / order.entry
                : (order.entry - order.currentPrice) / order.entry;
            
            return priceChange * order.positionSize;
        }

        // 初始化事件监听器
        function initEventListeners() {
            // 方向切换
            document.getElementById('longBtn').addEventListener('click', function() {
                isLong = true;
                this.classList.add('active');
                document.getElementById('shortBtn').classList.remove('active');
            });

            document.getElementById('shortBtn').addEventListener('click', function() {
                isLong = false;
                this.classList.add('active');
                document.getElementById('longBtn').classList.remove('active');
            });

            // 添加订单
            document.getElementById('addOrderBtn').addEventListener('click', addOrder);

            // 计算风险
            document.getElementById('calculateBtn').addEventListener('click', calculateComprehensiveRisk);

            // 重置
            document.getElementById('resetBtn').addEventListener('click', resetAll);

            // 模态框
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);

            // 资金变更监听
            document.getElementById('capital').addEventListener('input', updateAccountInfo);

            // 自动保存
            setInterval(autoSave, 30000); // 每30秒自动保存

            // 添加快捷键支持
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + S 保存
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveToLocal();
                }
                
                // Ctrl/Cmd + E 导出
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportToJSON();
                }
                
                // Esc 关闭模态框
                if (e.key === 'Escape') {
                    closeModal();
                }
            });

            // 添加离开页面提醒
            window.addEventListener('beforeunload', function(e) {
                if (orders.length > 0) {
                    autoSave();
                }
            });
        }

        // 初始化图表
        function initCharts() {
            // 资金分布饼图
            const positionCtx = document.getElementById('positionChart').getContext('2d');
            positionChart = new Chart(positionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['可用余额'],
                    datasets: [{
                        label: '资金分布',
                        data: [10000],
                        backgroundColor: ['#4caf50'],
                        borderColor: '#1d2433',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(2);
                                    return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 风险敞口柱状图
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            riskChart = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '潜在损失',
                        data: [],
                        backgroundColor: 'rgba(255, 61, 0, 0.6)',
                        borderColor: '#ff3d00',
                        borderWidth: 1
                    }, {
                        label: '潜在盈利',
                        data: [],
                        backgroundColor: 'rgba(0, 200, 83, 0.6)',
                        borderColor: '#00c853',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#e0e0e0',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    }
                }
            });
        }

        // 修正后的强平价格计算
        function calculateLiquidationPrice(entryPrice, leverage, direction, margin, capital) {
            // 验证输入
            if (!entryPrice || entryPrice <= 0 || !leverage || leverage <= 0) {
                return { isolated: 0, cross: 0 };
            }

            const maintainMarginRate = EXCHANGE_CONFIG.maintenanceMarginRate;
            const feeRate = EXCHANGE_CONFIG.takerFee;
            
            let isolatedLiqPrice, crossLiqPrice;
            
            // 计算持仓数量
            const positionSize = margin * leverage / entryPrice;
            
            if (direction === 'long' || direction === 'Long') {
                // 做多逐仓强平价格
                // 强平价格 = 开仓价格 × (1 - 1/杠杆 + 维持保证金率 + 手续费率×2)
                isolatedLiqPrice = entryPrice * (1 - 1/leverage + maintainMarginRate + feeRate * 2);
                
                // 做多全仓强平价格（考虑账户总资金）
                // 强平价格 = (开仓价格 × 持仓数量 - 账户总资金 × (1 - 维持保证金率)) / 持仓数量
                if (capital && capital > 0) {
                    crossLiqPrice = (entryPrice * positionSize - capital * (1 - maintainMarginRate)) / positionSize;
                    crossLiqPrice = Math.max(0, crossLiqPrice);
                } else {
                    crossLiqPrice = isolatedLiqPrice;
                }
            } else {
                // 做空逐仓强平价格
                // 强平价格 = 开仓价格 × (1 + 1/杠杆 - 维持保证金率 - 手续费率×2)
                isolatedLiqPrice = entryPrice * (1 + 1/leverage - maintainMarginRate - feeRate * 2);
                
                // 做空全仓强平价格（考虑账户总资金）
                // 强平价格 = (开仓价格 × 持仓数量 + 账户总资金 × (1 - 维持保证金率)) / 持仓数量
                if (capital && capital > 0) {
                    crossLiqPrice = (entryPrice * positionSize + capital * (1 - maintainMarginRate)) / positionSize;
                } else {
                    crossLiqPrice = isolatedLiqPrice;
                }
            }

            return {
                isolated: Math.max(0, isolatedLiqPrice),
                cross: Math.max(0, crossLiqPrice)
            };
        }

        // 添加订单
        function addOrder() {
            const coin = document.getElementById('coin').value.trim();
            const leverage = parseFloat(document.getElementById('leverage').value);
            const entry = parseFloat(document.getElementById('entry').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);
            const margin = parseFloat(document.getElementById('margin').value);

            // 验证输入
            if (!coin || !leverage || !entry || !margin) {
                showAlert('请填写所有必填字段', 'warning');
                return;
            }

            // 获取当前资金和风险配置
            const capital = parseFloat(document.getElementById('capital').value);
            const riskProfile = RISK_PROFILES[document.getElementById('riskTolerance').value];

            // 检查资金是否足够
            const totalUsedMargin = orders.reduce((sum, o) => sum + o.margin, 0);
            if (totalUsedMargin + margin > capital) {
                showAlert('保证金超过可用余额！', 'danger');
                return;
            }

            // 风险检查
            if (leverage > riskProfile.maxLeverage) {
                showAlert(`当前风险偏好下，建议杠杆不超过${riskProfile.maxLeverage}倍`, 'warning');
            }

            if ((totalUsedMargin + margin) / capital > riskProfile.maxMarginRatio) {
                showAlert(`总保证金将超过风险限制(${riskProfile.maxMarginRatio * 100}%)`, 'danger');
                return;
            }

            // 计算强平价格（包括逐仓和全仓）
            const liquidationPrices = calculateLiquidationPrice(entry, leverage, isLong ? 'long' : 'short', margin, capital);

            // 创建订单对象
            const order = {
                id: Date.now(),
                coin: coin.toUpperCase(),
                direction: isLong ? 'Long' : 'Short',
                leverage,
                entry,
                stopLoss: stopLoss || 0,
                takeProfit: takeProfit || 0,
                margin,
                liquidationPrice: liquidationPrices.isolated,  // 逐仓强平价
                crossLiquidationPrice: liquidationPrices.cross, // 全仓强平价
                positionSize: margin * leverage,
                createTime: new Date().toISOString()
            };

            // 计算潜在盈亏
            if (order.stopLoss) {
                order.potentialLoss = calculatePotentialLoss(order);
            }
            if (order.takeProfit) {
                order.potentialProfit = calculatePotentialProfit(order);
            }

            // 使用固定比例法验证风险
            if (order.stopLoss) {
                const actualRisk = order.potentialLoss / capital;
                if (actualRisk > riskProfile.riskPerTrade) {
                    showAlert(`该订单风险(${(actualRisk * 100).toFixed(1)}%)超过设定的单笔风险限制(${(riskProfile.riskPerTrade * 100).toFixed(0)}%)`, 'warning');
                }
            }

            orders.push(order);
            updateOrdersTable();
            updateAccountInfo();
            updateCharts();
            autoSave();
            showAlert('订单添加成功', 'success');

            // 清空输入
            document.getElementById('entry').value = '';
            document.getElementById('stopLoss').value = '';
            document.getElementById('takeProfit').value = '';
            document.getElementById('margin').value = '';
        }

        // 计算潜在损失
        function calculatePotentialLoss(order) {
            if (!order.stopLoss) return order.margin; // 如果没有止损，最大损失为全部保证金
            
            const priceChange = order.direction === 'Long' 
                ? (order.stopLoss - order.entry) / order.entry
                : (order.entry - order.stopLoss) / order.entry;
            
            const loss = Math.abs(priceChange * order.positionSize);
            return Math.min(loss, order.margin); // 损失不会超过保证金
        }

        // 计算潜在盈利
        function calculatePotentialProfit(order) {
            if (!order.takeProfit) return 0;
            
            const priceChange = order.direction === 'Long'
                ? (order.takeProfit - order.entry) / order.entry
                : (order.entry - order.takeProfit) / order.entry;
            
            return Math.max(0, priceChange * order.positionSize);
        }

        // 更新订单表格
        function updateOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #a0a0a0;">暂无订单</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${order.coin}</td>
                    <td><span class="tag ${order.direction === 'Long' ? 'tag-long' : 'tag-short'}">${order.direction}</span></td>
                    <td>${order.leverage}x</td>
                    <td>$${order.entry.toFixed(2)}</td>
                    <td>${order.stopLoss ? '$' + order.stopLoss.toFixed(2) : '-'}</td>
                    <td>${order.takeProfit ? '$' + order.takeProfit.toFixed(2) : '-'}</td>
                    <td>$${order.margin.toFixed(2)}</td>
                    <td>
                        <div class="liquidation-prices">
                            <div class="liq-price liq-isolated">逐仓: $${order.liquidationPrice.toFixed(2)}</div>
                            <div class="liq-price liq-cross">全仓: $${(order.crossLiquidationPrice || order.liquidationPrice).toFixed(2)}</div>
                        </div>
                    </td>
                    <td>
                        <button class="btn-edit" onclick="editOrder(${order.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-delete" onclick="deleteOrder(${order.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 删除订单
        function deleteOrder(id) {
            if (confirm('确定要删除这个订单吗？')) {
                orders = orders.filter(order => order.id !== id);
                updateOrdersTable();
                updateAccountInfo();
                updateCharts();
                if (orders.length > 0) {
                    calculateComprehensiveRisk();
                }
                showAlert('订单已删除', 'success');
            }
        }

        // 编辑订单
        function editOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;

            document.getElementById('editOrderId').value = id;
            document.getElementById('editCoin').value = order.coin;
            document.getElementById('editLeverage').value = order.leverage;
            document.getElementById('editEntry').value = order.entry;
            document.getElementById('editStopLoss').value = order.stopLoss || '';
            document.getElementById('editTakeProfit').value = order.takeProfit || '';
            document.getElementById('editMargin').value = order.margin;

            document.getElementById('editModal').style.display = 'block';
        }

        // 保存编辑的订单
        function saveEditOrder() {
            const id = parseInt(document.getElementById('editOrderId').value);
            const order = orders.find(o => o.id === id);
            if (!order) return;

            const newMargin = parseFloat(document.getElementById('editMargin').value);
            const capital = parseFloat(document.getElementById('capital').value);
            const totalUsedMargin = orders.reduce((sum, o) => o.id === id ? sum : sum + o.margin, 0);
            
            // 检查资金是否足够
            if (totalUsedMargin + newMargin > capital) {
                showAlert('保证金超过可用余额！', 'danger');
                return;
            }

            order.coin = document.getElementById('editCoin').value;
            order.leverage = parseFloat(document.getElementById('editLeverage').value);
            order.entry = parseFloat(document.getElementById('editEntry').value);
            order.stopLoss = parseFloat(document.getElementById('editStopLoss').value) || 0;
            order.takeProfit = parseFloat(document.getElementById('editTakeProfit').value) || 0;
            order.margin = newMargin;

            // 重新计算强平价格
            const liquidationPrices = calculateLiquidationPrice(order.entry, order.leverage, order.direction, order.margin, capital);
            order.liquidationPrice = liquidationPrices.isolated;
            order.crossLiquidationPrice = liquidationPrices.cross;
            order.positionSize = order.margin * order.leverage;
            
            if (order.stopLoss) {
                order.potentialLoss = calculatePotentialLoss(order);
            }
            if (order.takeProfit) {
                order.potentialProfit = calculatePotentialProfit(order);
            }

            updateOrdersTable();
            updateAccountInfo();
            updateCharts();
            calculateComprehensiveRisk();
            closeModal();
            showAlert('订单已更新', 'success');
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // 计算综合风险
        function calculateComprehensiveRisk() {
            if (orders.length === 0) {
                showAlert('请先添加订单', 'warning');
                return;
            }

            const capital = parseFloat(document.getElementById('capital').value);
            const riskProfile = RISK_PROFILES[document.getElementById('riskTolerance').value];

            // 基础指标计算
            const totalMargin = orders.reduce((sum, order) => sum + order.margin, 0);
            const marginRatio = (totalMargin / capital) * 100;
            const totalExposure = orders.reduce((sum, order) => sum + order.positionSize, 0);
            const maxPotentialLoss = orders.reduce((sum, order) => sum + (order.potentialLoss || order.margin), 0);

            // 更新基础指标显示
            const totalMarginIndicator = document.getElementById('totalMarginIndicator');
            totalMarginIndicator.innerHTML = `
                <div class="label">总保证金</div>
                <div class="value">$${totalMargin.toFixed(2)}</div>
                <div class="description">占总资金: ${marginRatio.toFixed(1)}%</div>
            `;

            const marginIndicator = document.getElementById('marginRatioIndicator');
            marginIndicator.className = 'indicator';
            if (marginRatio > 80) marginIndicator.classList.add('danger');
            else if (marginRatio > 50) marginIndicator.classList.add('warning');
            else marginIndicator.classList.add('success');
            
            marginIndicator.innerHTML = `
                <div class="label">保证金使用率</div>
                <div class="value">${marginRatio.toFixed(1)}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(marginRatio, 100)}%"></div>
                </div>
            `;

            document.getElementById('totalExposureIndicator').innerHTML = `
                <div class="label">总持仓价值</div>
                <div class="value">$${totalExposure.toFixed(2)}</div>
                <div class="description">杠杆后价值</div>
            `;

            const maxLossIndicator = document.getElementById('maxLossIndicator');
            maxLossIndicator.className = 'indicator';
            const lossRatio = (maxPotentialLoss / capital) * 100;
            if (lossRatio > 20) maxLossIndicator.classList.add('danger');
            else if (lossRatio > 10) maxLossIndicator.classList.add('warning');
            else maxLossIndicator.classList.add('success');
            
            maxLossIndicator.innerHTML = `
                <div class="label">最大潜在损失</div>
                <div class="value">-$${maxPotentialLoss.toFixed(2)}</div>
                <div class="description">占总资金: ${lossRatio.toFixed(1)}%</div>
            `;

            // 计算高级风险指标
            const advancedMetrics = calculateAdvancedMetrics(orders, capital);
            
            // 更新高级指标显示
            document.getElementById('varValue').textContent = `-$${advancedMetrics.var95.toFixed(2)} (${(advancedMetrics.var95/capital*100).toFixed(1)}%)`;
            document.getElementById('maxDrawdown').textContent = `${advancedMetrics.maxDrawdown.toFixed(1)}%`;
            document.getElementById('profitLossRatio').textContent = advancedMetrics.profitLossRatio.toFixed(2);
            document.getElementById('fixedFractionSuggestion').textContent = advancedMetrics.fixedFractionSuggestion;
            document.getElementById('correlationRisk').textContent = getRiskLevel(advancedMetrics.correlationRisk);
            document.getElementById('riskAdjustedReturn').textContent = `${advancedMetrics.riskAdjustedReturn.toFixed(1)}%`;

            // 更新图表
            updateChartsWithCapital(capital);

            // 生成智能建议
            generateRecommendations(totalMargin, marginRatio, maxPotentialLoss, capital, advancedMetrics, riskProfile);
        }

        // 计算高级风险指标（包含固定比例法）
        function calculateAdvancedMetrics(orders, capital) {
            // VaR计算 (95%置信水平)
            const returns = orders.map(order => {
                const loss = order.potentialLoss || order.margin;
                return -loss / capital;
            });
            const sortedReturns = returns.sort((a, b) => a - b);
            const var95Index = Math.floor(sortedReturns.length * 0.05);
            const var95 = Math.abs(sortedReturns[var95Index] || 0) * capital;

            // 最大回撤
            const maxDrawdown = calculateMaxDrawdown(orders, capital);

            // 盈亏比
            const totalProfit = orders.reduce((sum, order) => sum + (order.potentialProfit || 0), 0);
            const totalLoss = orders.reduce((sum, order) => sum + (order.potentialLoss || order.margin), 0);
            const profitLossRatio = totalLoss > 0 ? totalProfit / totalLoss : 0;

            // 固定比例法建议
            const fixedFractionSuggestion = calculateFixedFractionSuggestion(orders, capital);

            // 相关性风险（修正版）
            const correlationRisk = calculateCorrelationRisk(orders);

            // 风险调整收益
            const expectedReturn = orders.reduce((sum, order) => {
                const profit = order.potentialProfit || 0;
                const loss = order.potentialLoss || order.margin;
                return sum + (profit - loss) / capital;
            }, 0);
            
            const volatility = calculateVolatility(orders, capital);
            const riskAdjustedReturn = expectedReturn * 100 * (1 - Math.min(volatility, 1));

            return {
                var95,
                maxDrawdown,
                profitLossRatio,
                fixedFractionSuggestion,
                correlationRisk,
                riskAdjustedReturn
            };
        }

        // 计算固定比例法建议
        function calculateFixedFractionSuggestion(orders, capital) {
            const riskProfile = RISK_PROFILES[document.getElementById('riskTolerance').value];
            const targetRisk = riskProfile.riskPerTrade;
            
            // 计算当前平均单笔风险
            const avgRisk = orders.reduce((sum, order) => {
                const risk = (order.potentialLoss || order.margin) / capital;
                return sum + risk;
            }, 0) / orders.length;
            
            // 计算建议的仓位调整
            let suggestion;
            if (avgRisk > targetRisk * 1.5) {
                suggestion = `风险过高，建议减仓${((avgRisk - targetRisk) * 100).toFixed(1)}%`;
            } else if (avgRisk < targetRisk * 0.5) {
                suggestion = `风险偏低，可增仓${((targetRisk - avgRisk) * 100).toFixed(1)}%`;
            } else {
                suggestion = `风险适中(${(avgRisk * 100).toFixed(1)}%)`;
            }
            
            return suggestion;
        }

        // 计算最大回撤
        function calculateMaxDrawdown(orders, capital) {
            let currentCapital = capital;
            let peak = capital;
            let maxDrawdown = 0;

            orders.forEach(order => {
                const loss = order.potentialLoss || order.margin;
                currentCapital -= loss;
                const drawdown = ((peak - currentCapital) / peak) * 100;
                maxDrawdown = Math.max(maxDrawdown, drawdown);
                
                const profit = order.potentialProfit || 0;
                currentCapital += profit;
                peak = Math.max(peak, currentCapital);
            });

            return maxDrawdown;
        }

        // 计算波动率
        function calculateVolatility(orders, capital) {
            const returns = orders.map(order => {
                const profit = order.potentialProfit || 0;
                const loss = order.potentialLoss || order.margin;
                return (profit - loss) / capital;
            });

            if (returns.length === 0) return 0;

            const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
            const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / returns.length;
            return Math.sqrt(variance);
        }

        // 修正的相关性风险计算
        function calculateCorrelationRisk(orders) {
            if (orders.length === 0) return 0;

            let correlationScore = 0;

            // 1. 方向集中度风险（所有订单同向的风险）
            const longOrders = orders.filter(o => o.direction === 'Long').length;
            const shortOrders = orders.filter(o => o.direction === 'Short').length;
            const directionBalance = Math.abs(longOrders - shortOrders) / orders.length;
            correlationScore += directionBalance * 0.4; // 权重40%

            // 2. 币种集中度风险
            const coinGroups = {};
            orders.forEach(order => {
                coinGroups[order.coin] = (coinGroups[order.coin] || 0) + 1;
            });
            const uniqueCoins = Object.keys(coinGroups).length;
            const diversification = 1 - (uniqueCoins / orders.length);
            correlationScore += diversification * 0.3; // 权重30%

            // 3. 杠杆集中度风险（高杠杆订单的比例）
            const highLeverageOrders = orders.filter(o => o.leverage > 10).length;
            const leverageRisk = highLeverageOrders / orders.length;
            correlationScore += leverageRisk * 0.3; // 权重30%

            return Math.min(1, correlationScore); // 限制在0-1之间
        }

        // 获取风险等级描述
        function getRiskLevel(value) {
            if (value < 0.3) return '低';
            if (value < 0.6) return '中';
            if (value < 0.8) return '高';
            return '极高';
        }

        // 生成智能建议（基于固定比例法）
        function generateRecommendations(totalMargin, marginRatio, maxLoss, capital, metrics, riskProfile) {
            const recommendations = [];
            
            // 保证金使用率建议
            if (marginRatio > 80) {
                recommendations.push({
                    type: 'danger',
                    text: `保证金使用率过高(${marginRatio.toFixed(1)}%)，强平风险极大！建议立即减仓`
                });
            } else if (marginRatio > riskProfile.maxMarginRatio * 100) {
                recommendations.push({
                    type: 'warning',
                    text: `保证金使用率(${marginRatio.toFixed(1)}%)超过风险偏好限制(${riskProfile.maxMarginRatio * 100}%)`
                });
            } else if (marginRatio < 30) {
                recommendations.push({
                    type: 'success',
                    text: `保证金使用率合理(${marginRatio.toFixed(1)}%)，风险可控`
                });
            }

            // 基于固定比例法的风险建议
            const avgRiskPerTrade = orders.reduce((sum, order) => {
                return sum + (order.potentialLoss || order.margin) / capital;
            }, 0) / orders.length;
            
            if (avgRiskPerTrade > riskProfile.riskPerTrade * 1.5) {
                recommendations.push({
                    type: 'danger',
                    text: `平均单笔风险(${(avgRiskPerTrade * 100).toFixed(1)}%)超过固定比例法建议的${(riskProfile.riskPerTrade * 100).toFixed(0)}%，请降低仓位`
                });
            } else if (avgRiskPerTrade < riskProfile.riskPerTrade * 0.5) {
                recommendations.push({
                    type: 'info',
                    text: `当前风险偏低，根据固定比例法，可适当增加仓位至单笔风险${(riskProfile.riskPerTrade * 100).toFixed(0)}%`
                });
            }

            // 最大损失建议
            const lossRatio = (maxLoss / capital) * 100;
            if (lossRatio > 20) {
                recommendations.push({
                    type: 'danger',
                    text: `总潜在损失(${lossRatio.toFixed(1)}%)过高，建议分批减仓或设置更严格的止损`
                });
            }

            // VaR建议
            const varRatio = (metrics.var95 / capital) * 100;
            if (varRatio > 10) {
                recommendations.push({
                    type: 'warning',
                    text: `风险价值(VaR)较高，95%置信水平下可能损失${varRatio.toFixed(1)}%的资金`
                });
            }

            // 盈亏比建议
            if (metrics.profitLossRatio < 1) {
                recommendations.push({
                    type: 'danger',
                    text: `盈亏比过低(${metrics.profitLossRatio.toFixed(2)})，潜在盈利小于潜在亏损，建议调整止盈止损位`
                });
            } else if (metrics.profitLossRatio > 2) {
                recommendations.push({
                    type: 'success',
                    text: `盈亏比优秀(${metrics.profitLossRatio.toFixed(2)})，风险收益结构合理`
                });
            } else {
                recommendations.push({
                    type: 'info',
                    text: `盈亏比为${metrics.profitLossRatio.toFixed(2)}，建议保持在1.5以上`
                });
            }

            // 相关性风险建议
            if (metrics.correlationRisk > 0.7) {
                recommendations.push({
                    type: 'danger',
                    text: '持仓相关性风险极高！建议分散方向、币种和降低杠杆'
                });
            } else if (metrics.correlationRisk > 0.5) {
                recommendations.push({
                    type: 'warning',
                    text: '持仓存在中度相关性风险，建议适当分散投资'
                });
            }

            // 强平风险建议
            const minDistance = orders.reduce((min, order) => {
                const distanceRatio = order.direction === 'Long' 
                    ? (order.entry - order.liquidationPrice) / order.entry
                    : (order.liquidationPrice - order.entry) / order.entry;
                return Math.min(min, distanceRatio);
            }, 1);
            
            if (minDistance < 0.05) {
                recommendations.push({
                    type: 'danger',
                    text: `有订单距离强平价格不足5%，请立即调整仓位或补充保证金`
                });
            } else if (minDistance < 0.1) {
                recommendations.push({
                    type: 'warning',
                    text: `有订单距离强平价格不足10%，建议密切关注市场波动`
                });
            }

            // 可用余额建议
            const availableBalance = capital - totalMargin;
            const availableRatio = (availableBalance / capital) * 100;
            if (availableRatio < 20) {
                recommendations.push({
                    type: 'warning',
                    text: `可用余额仅剩${availableRatio.toFixed(1)}%，建议保留更多流动资金应对突发情况`
                });
            }

            // 固定比例法原则提醒
            recommendations.push({
                type: 'info',
                text: `根据固定比例法，每笔交易风险应控制在账户的${(riskProfile.riskPerTrade * 100).toFixed(0)}%以内`
            });
            
            // 一般建议
            recommendations.push({
                type: 'info',
                text: '建议设置止损单保护本金，避免黑天鹅事件'
            });

            // 更新建议显示
            const recommendationsHtml = recommendations.map(rec => {
                return `<li class="${rec.type}">${rec.text}</li>`;
            }).join('');

            document.getElementById('riskRecommendations').innerHTML = `
                <ul class="recommendation-list">${recommendationsHtml}</ul>
            `;
        }

        // 更新图表（包含资金信息）
        function updateChartsWithCapital(capital) {
            if (!capital || capital <= 0) {
                updateCharts();
                return;
            }

            // 更新资金分布饼图
            const totalMargin = orders.reduce((sum, order) => sum + order.margin, 0);
            const availableBalance = capital - totalMargin;
            
            // 按币种分组计算保证金
            const coinMargins = {};
            orders.forEach(order => {
                const key = `${order.coin} (${order.direction})`;
                coinMargins[key] = (coinMargins[key] || 0) + order.margin;
            });

            const labels = ['可用余额', ...Object.keys(coinMargins)];
            const data = [availableBalance, ...Object.values(coinMargins)];
            
            const colors = ['#4caf50'];
            Object.keys(coinMargins).forEach((key, index) => {
                if (key.includes('Long')) {
                    colors.push(`rgba(0, 200, 83, ${0.8 - index * 0.1})`);
                } else {
                    colors.push(`rgba(255, 61, 0, ${0.8 - index * 0.1})`);
                }
            });

            positionChart.data.labels = labels;
            positionChart.data.datasets[0].data = data;
            positionChart.data.datasets[0].backgroundColor = colors;
            positionChart.update();

            // 更新风险敞口柱状图
            const chartLabels = orders.map(o => `${o.coin} ${o.leverage}x`);
            const losses = orders.map(o => o.potentialLoss || o.margin);
            const profits = orders.map(o => o.potentialProfit || 0);

            riskChart.data.labels = chartLabels;
            riskChart.data.datasets[0].data = losses;
            riskChart.data.datasets[1].data = profits;
            riskChart.update();
        }

        // 更新图表（基础版本）
        function updateCharts() {
            if (orders.length === 0) {
                // 显示默认状态
                const capital = parseFloat(document.getElementById('capital').value) || 10000;
                
                positionChart.data.labels = ['可用余额'];
                positionChart.data.datasets[0].data = [capital];
                positionChart.data.datasets[0].backgroundColor = ['#4caf50'];
                positionChart.update();

                riskChart.data.labels = [];
                riskChart.data.datasets[0].data = [];
                riskChart.data.datasets[1].data = [];
                riskChart.update();
                return;
            }

            const capital = parseFloat(document.getElementById('capital').value);
            updateChartsWithCapital(capital);
        }

        // 显示提示信息
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            const alertId = Date.now();
            
            const alertHtml = `
                <div class="alert ${type}" id="alert-${alertId}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            alertBox.insertAdjacentHTML('beforeend', alertHtml);
            
            // 3秒后自动移除
            setTimeout(() => {
                const alertElement = document.getElementById(`alert-${alertId}`);
                if (alertElement) {
                    alertElement.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => alertElement.remove(), 300);
                }
            }, 3000);
        }

        // 重置所有数据
        function resetAll() {
            if (confirm('确定要重置所有数据吗？此操作不可撤销。')) {
                orders = [];
                document.getElementById('capital').value = 10000;
                document.getElementById('riskTolerance').value = 'moderate';
                updateOrdersTable();
                updateAccountInfo();
                updateCharts();
                
                // 重置显示
                document.getElementById('totalMarginIndicator').innerHTML = `
                    <div class="label">总保证金</div>
                    <div class="value">0 USDT</div>
                    <div class="description">占总资金: 0%</div>
                `;
                document.getElementById('marginRatioIndicator').innerHTML = `
                    <div class="label">保证金使用率</div>
                    <div class="value">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                `;
                document.getElementById('totalExposureIndicator').innerHTML = `
                    <div class="label">总持仓价值</div>
                    <div class="value">0 USDT</div>
                    <div class="description">杠杆后价值</div>
                `;
                document.getElementById('maxLossIndicator').innerHTML = `
                    <div class="label">最大潜在损失</div>
                    <div class="value">0 USDT</div>
                    <div class="description">占总资金: 0%</div>
                `;
                
                // 重置高级指标
                document.getElementById('varValue').textContent = '-';
                document.getElementById('maxDrawdown').textContent = '-';
                document.getElementById('profitLossRatio').textContent = '-';
                document.getElementById('fixedFractionSuggestion').textContent = '-';
                document.getElementById('correlationRisk').textContent = '-';
                document.getElementById('riskAdjustedReturn').textContent = '-';
                
                document.getElementById('riskRecommendations').innerHTML = `
                    <ul class="recommendation-list">
                        <li class="success">系统已重置，请添加订单进行分析</li>
                    </ul>
                `;
                
                localStorage.removeItem('tradingOrders');
                localStorage.removeItem('tradingSettings');
                
                showAlert('所有数据已重置', 'success');
            }
        }

        // 导出为JSON
        function exportToJSON() {
            const capital = parseFloat(document.getElementById('capital').value);
            const data = {
                version: '2.4',
                exportTime: new Date().toISOString(),
                settings: {
                    capital: capital,
                    riskTolerance: document.getElementById('riskTolerance').value
                },
                orders: orders,
                metrics: orders.length > 0 ? calculateAdvancedMetrics(orders, capital) : null,
                summary: {
                    totalMargin: orders.reduce((sum, o) => sum + o.margin, 0),
                    availableBalance: capital - orders.reduce((sum, o) => sum + o.margin, 0),
                    totalExposure: orders.reduce((sum, o) => sum + o.positionSize, 0),
                    maxPotentialLoss: orders.reduce((sum, o) => sum + (o.potentialLoss || o.margin), 0)
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trading_risk_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('数据已导出为JSON文件', 'success');
        }

        // 导出为CSV
        function exportToCSV() {
            if (orders.length === 0) {
                showAlert('没有可导出的数据', 'warning');
                return;
            }
            
            const capital = parseFloat(document.getElementById('capital').value);
            const headers = ['交易对', '方向', '杠杆', '开仓价格', '止损价', '止盈价', '保证金', '保证金占比', '逐仓强平价', '全仓强平价', '持仓价值', '潜在损失', '潜在盈利'];
            const rows = orders.map(order => [
                order.coin,
                order.direction,
                order.leverage,
                order.entry,
                order.stopLoss || '',
                order.takeProfit || '',
                order.margin,
                ((order.margin / capital) * 100).toFixed(2) + '%',
                order.liquidationPrice.toFixed(2),
                (order.crossLiquidationPrice || order.liquidationPrice).toFixed(2),
                order.positionSize.toFixed(2),
                (order.potentialLoss || 0).toFixed(2),
                (order.potentialProfit || 0).toFixed(2)
            ]);
            
            // 添加汇总行
            const totalMargin = orders.reduce((sum, o) => sum + o.margin, 0);
            const totalExposure = orders.reduce((sum, o) => sum + o.positionSize, 0);
            const totalLoss = orders.reduce((sum, o) => sum + (o.potentialLoss || 0), 0);
            const totalProfit = orders.reduce((sum, o) => sum + (o.potentialProfit || 0), 0);
            
            rows.push([]);
            rows.push(['汇总', '', '', '', '', '', totalMargin.toFixed(2), ((totalMargin/capital)*100).toFixed(2)+'%', '', '', totalExposure.toFixed(2), totalLoss.toFixed(2), totalProfit.toFixed(2)]);
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trading_orders_${new Date().getTime()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('数据已导出为CSV文件', 'success');
        }

        // 保存到本地存储
        function saveToLocal() {
            const data = {
                orders: orders,
                settings: {
                    capital: document.getElementById('capital').value,
                    riskTolerance: document.getElementById('riskTolerance').value
                }
            };
            
            localStorage.setItem('tradingOrders', JSON.stringify(data.orders));
            localStorage.setItem('tradingSettings', JSON.stringify(data.settings));
            
            showAlert('数据已保存到本地存储', 'success');
        }

        // 从本地存储加载
        function loadFromLocal(showMessage = true) {
            try {
                const savedOrders = localStorage.getItem('tradingOrders');
                const savedSettings = localStorage.getItem('tradingSettings');
                
                if (savedOrders) {
                    orders = JSON.parse(savedOrders);
                    // 确保旧数据兼容性
                    const capital = parseFloat(document.getElementById('capital').value);
                    orders.forEach(order => {
                        if (!order.crossLiquidationPrice) {
                            const liquidationPrices = calculateLiquidationPrice(
                                order.entry,
                                order.leverage,
                                order.direction,
                                order.margin,
                                capital
                            );
                            order.crossLiquidationPrice = liquidationPrices.cross;
                        }
                    });
                    updateOrdersTable();
                }
                
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    document.getElementById('capital').value = settings.capital || 10000;
                    document.getElementById('riskTolerance').value = settings.riskTolerance || 'moderate';
                }
                
                updateAccountInfo();
                updateCharts();
                
                if (showMessage) {
                    showAlert('数据已从本地存储加载', 'success');
                    if (orders.length > 0) {
                        calculateComprehensiveRisk();
                    }
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                if (showMessage) {
                    showAlert('加载数据失败', 'danger');
                }
            }
        }

        // 自动保存
        function autoSave() {
            saveToLocal();
        }
    </script>
</body>
</html>